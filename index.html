<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ABSENSI KPU KABUPATEN SUBANG</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">

    <!-- SweetAlert CSS -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
	<meta name="theme-color" content="#0d6efd">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="mobile-web-app-capable" content="yes">

	
	<style>
		#fotoProfil{
			width: 120px;
			height: 120px;
			border-radius: 50%;
			background-color: #ddd;
			background-size: cover;
			background-position: center;
			background-repeat: no-repeat;
			position: absolute;
			top: 60px;
			z-index: 9;
			border: 5px solid white;
			left: 50%;
			transform: translateX(-50%);
		}
		#nml{
			position: absolute;
			top: 15px;
			text-align: center;
			color: white;
			width: 100%;
			left: 50%;
			transform: translateX(-50%);
			font-size:25px;
		}
		#navbg{
			width: 100%;
			height: 150px;
			position: relative;
			border-bottom-left-radius: 20px;
			border-bottom-right-radius: 20px;
			display: flex;
			align-items: center;
			justify-content: center;
		}
		#navbg2{
			width: 90%;
			height: 150px;
			background-color: white;
			position: relative;
			border-radius: 10px;
			align-items: center;
			justify-content: center;
			position: absolute;
			top: 100px;
			left: 50%;
			transform: translateX(-50%);
			box-shadow: 0px 5px 10px rgba(0, 0, 0, 0.2);
		}
		#jamdigital{
			font-size: 30px;
			font-weight:bold;
		}
		#date{
			color: gray;
		}
		#jame{
			width: fit-content;
			margin: auto;
			padding: 10px;
			line-height: initial;
			border-radius: 5px;
			border:1px solid lightgray;
		}
		.tengah{text-align: center;vertical-align: middle;}
		.kanan{text-align: right;vertical-align: middle;padding:0px}
		#formPetugas, #formMunfiq{
			padding:15px;
			border: 2px solid blue;
			border-radius: 10px;
		}
		.hidden {
			display: none;
		}

		@media print {
		  table {
			page-break-inside: avoid;
			width: 100%;
		  }
		  tr {
			page-break-inside: avoid;
		  }
		  th, td {
			page-break-inside: avoid;
		  }
		  .noprint{display:none}
		}

	</style>
</head>
<body>
    <!-- Div pertama -->
	<div id="lembaga" class="text-center" style="margin-top:10px;padding:15px;display:none">
		<div id="logo" width: 50px; height: auto;></div>
        <h4 id="namaLembaga" style="color:black;margin:0px auto;"></h4>
        <h6 id="alamatLembaga" style="color:black;margin:0px auto;"></h6>
	</div>
    
    <!-- Div kedua -->
     <div id="div2" class="hal awal" style="padding:20px;display:none">
        <form id="formPetugas">
			<h3 style="text-align:center">Login Pegawai</h3>
            <div class="mb-3">
                <label for="usernamePetugas" class="form-label">NIP</label>
                <input type="text" id="usernamePetugas" class="form-control" placeholder="Masukan NIP anda" required>
            </div>
            <div class="mb-3">
                <label for="passwordPetugas" class="form-label">Password</label>
                <input type="password" id="passwordPetugas" class="form-control" placeholder="Kata Sandi" required>
            </div>
			<div style="text-align:center">
				<span class="btn btn-secondary" onclick="awal()" style="display:none">CANCEL</span>
				<button type="submit" class="btn btn-success">LOGIN</button>
			</div>
        </form>
    </div>
	
	<div id="halPetugas" class="hal" style="display:none">
		<div id="divok" style="padding:0px">
			<div id="navbg" class="bg-primary"></div>
			<div id="navbg2" style="z-index:5"></div>
			<div id="welcomePetugas" style="padding:20px;margin-top:5px">
				<div id="nml" class="namaLembaga"></div>
				<h3 style="position:relative;top: 10px;z-index: 7;text-align:center;margin-bottom:0px"><span class="namaPetugas"></span></h3>
				<h6 style="position:relative;top: 10px;z-index: 7;text-align:center;"><span class="posisiPetugas"></span></h6>
				<div id="fotoProfil"></div>
				<div id="luarRadius" style="border:2px solid red;border-radius:5px;padding:5px;text-align:center;margin-top:50px;display:none">
					<h2>ANDA BELUM MEMASUKI AREA ABSENSI</h2><br>
					<button class="btn btn-danger" onclick="logout()">Logout</button>
				</div>
				<div id="dalamRadius" style="border:2px solid #0d6efd;border-radius:5px;padding:5px;text-align:center;margin-top:50px;display:none">
					<div style="padding:5px;margin:10px auto;border-bottom:1px solid lightgray;">
						<button class="btn btn-primary" onclick="getPresensi()">Absensi</button>
						<button class="btn btn-secondary" onclick="rekap()">Rekap</button>
						<div id="menuAdmin" style="display:none; margin-top:10px">
  							<button class="btn btn-dark" onclick="halamanAdmin()">
    						<i class="bi bi-shield-lock"></i>Halaman Admin
  							</button>
						</div>
						<button class="btn btn-danger" onclick="logout()">Logout</button>
					</div>
					<div id="prapresensi">
						<h3>Selamat Datang di Absensi Online.</h3>
						<p>Silakan pilih fungsi dengan klik tombol.</p>
					</div>
					<div id="presensi" style="display:none">
						<div id="jame">
							<div id="jamdigital">Loading...</div>
							<div id="date">Loading...</div>
							<div id="bulanok" style="display:none"></div>
							<div id="tanggalok" style="display:none"></div>
						</div>
						<div style="text-align:center;padding:10px;">
							Jam Masuk dan Pulang Anda:
							<div style="font-weight:bold">Masuk: <span id="jamMasuk">-</span>  |  Pulang: <span id="jamPulang">-</span></div>
						</div>
						<div style="text-align:center;padding:10px;">
							<button class="btn btn-success" onclick="presensi('M')">MASUK</button>
							<button class="btn btn-warning" onclick="presensi('P')">PULANG</button>
						</div>
					</div>
					<div id="rekap" style="display:none">
						<h4>Rekap Absensi</h4>
						<select id="pilihBulan" class="form-control" style="margin-bottom:20px">
							<option selected disabled>Pilih Bulan</option>
							<option value="JAN">JANUARI</option>
							<option value="FEB">FEBRUARI</option>
							<option value="MAR">MARET</option>
							<option value="APR">APRIL</option>
							<option value="MEI">MEI</option>
							<option value="JUN">JUNI</option>
							<option value="JUL">JULI</option>
							<option value="AGU">AGUSTUS</option>
							<option value="SEP">SEPTEMBER</option>
							<option value="OKT">OKTOBER</option>
							<option value="NOV">NOVEMBER</option>
							<option value="DES">DESEMBER</option>
						</select>
						<button class="btn btn-success" onclick="rekapbulan()">TAMPILKAN</button>
						
						<div id="divTabelRekap" class="table-responsive" style="margin-top: 20px;display:none">
							<table id="tabelRekap" class="table table-bordered table-striped">
							<thead class="thead-dark">
								<tr class="tengah">
									<th>Hari / Tanggal</th>
									<th>Masuk</th>
									<th>Pulang</th>
									<th>Keterangan</th>
								</tr>
							</thead>
							<tbody id="tabelRekapBody">
							</tbody>
						</table>
						</div>
					</div>
				</div>
			</div>
		</div>
		
	</div>

	<!-- MODAL ADMIN -->
<div class="modal fade" id="modalAdmin" tabindex="-1">
  <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">

      <div class="modal-header bg-dark text-white">
        <h5 class="modal-title">
          <i class="bi bi-shield-lock"></i> HALAMAN ADMIN
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">

        <div class="d-flex justify-content-between mb-3">
          <div>
            Role: <b id="roleAdmin"></b>
          </div>
          <button class="btn btn-success btn-sm" onclick="formTambahPegawai()">
            + Tambah Pegawai
          </button>
        </div>

        <div class="table-responsive">
          <table class="table table-bordered table-striped">
            <thead class="table-dark text-center">
              <tr>
                <th>NIP</th>
                <th>Nama</th>
                <th>Jabatan</th>
                <th>Role</th>
                <th>Aksi</th>
              </tr>
            </thead>
            <tbody id="tabelPegawai"></tbody>
          </table>
        </div>

      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">
          Tutup
        </button>
      </div>

    </div>
  </div>
</div>

<div class="modal fade" id="modalPegawai" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title" id="judulPegawai">Tambah Pegawai</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <input type="hidden" id="modePegawai">

        <div class="mb-2">
          <label>NIP</label>
          <input type="text" id="nipPegawai" class="form-control">
        </div>

        <div class="mb-2">
          <label>Nama</label>
          <input type="text" id="namaPegawai" class="form-control">
        </div>

        <div class="mb-2">
          <label>Jabatan</label>
          <input type="text" id="jabatanPegawai" class="form-control">
        </div>

        <div class="mb-2">
          <label>Role</label>
          <select id="rolePegawai" class="form-control">
            <option value="USER">USER</option>
            <option value="ADMIN">ADMIN</option>
          </select>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-success" onclick="simpanPegawai()">
          Simpan
        </button>
      </div>

    </div>
  </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<script>

	function getDeviceId() {
		let id = localStorage.getItem("device_id");

		if (!id) {
			id = "DEV-" + crypto.randomUUID();
			localStorage.setItem("device_id", id);
		}

		return id;
	}



    $(document).ready(function() 
	{
		if(localStorage.getItem('statuslogin')=='petugas')
		{
			loadHalPTK();
			$('#halPetugas').show();
		}else if(localStorage.getItem('statuslogin')=='munfiq')
		{
			loadHalPelanggan();
			$('#halPelanggan').show();
		}else
		{
			firstLoad();
		}
        $("#btnPetugas").click(function() 
		{
            loginPetugas();
        });
		$("#btnPelanggan").click(function() 
		{
            loginMunfiq();
        });

        // Form login petugas
        $("#formPetugas").submit(function(e) 
		{
			e.preventDefault();
			logPetugas();
			loadLibur();
		});
		
		// Form login pelanggan
        $("#formMunfiq").submit(function(e) 
		{
			e.preventDefault();
			logMunfiq();
		});
		
		$(document).on('click', '.nav-link', function () 
		{
			$('.navbar-collapse').collapse('hide');
		});
    });
	
	let ramadhanMulai = null;
	let ramadhanSelesai = null;
	
	let dataLibur = [];
	let serverTimestamp = 0;
    let localStartTime = 0;
	async function fetchServerTime() 
	{
		try 
		{
			let response = await fetch("https://appsekolah.my.id/waktu.php");
			let data = await response.json();

			serverTimestamp = data.timestamp;
			localStartTime = Math.floor(Date.now() / 1000);

			updateClock();
		} catch (error) 
		{
			console.error("Gagal mengambil waktu dari server", error);
			document.getElementById("jamdigital").innerText = "Gagal memuat waktu";
			document.getElementById("date").innerText = "";
		}
	}

	// Fungsi untuk memperbarui jam setiap detik dengan waktu yang dihitung di klien
	function updateClock() 
	{
		let now = Math.floor(Date.now() / 1000);
		let elapsed = now - localStartTime;
		let currentTimestamp = serverTimestamp + elapsed;

		let serverTime = new Date(currentTimestamp * 1000);
		//document.getElementById("jamdigital").innerText = serverTime.toLocaleTimeString("id-ID");
		let jam = serverTime.getHours().toString().padStart(2, "0");
		let menit = serverTime.getMinutes().toString().padStart(2, "0");
		let detik = serverTime.getSeconds().toString().padStart(2, "0");

		document.getElementById("jamdigital").innerText = `${jam}:${menit}:${detik}`;

		document.getElementById("date").innerText = serverTime.toLocaleDateString("id-ID", 
		{ 
			weekday: 'long', 
			day: 'numeric', 
			month: 'long', 
			year: 'numeric' 
		});
		const monthNames = ["JAN", "FEB", "MAR", "APR", "MEI", "JUN", "JUL", "AGU", "SEP", "OKT", "NOV", "DES"];
		if(sessionStorage.getItem('bulanok') != monthNames[serverTime.getMonth()])
		{
			sessionStorage.setItem('bulanok',monthNames[serverTime.getMonth()]);
		};
		if(sessionStorage.getItem('tanggalok') != serverTime.getDate())
		{
			sessionStorage.setItem('tanggalok',serverTime.getDate());
		};
		
		//document.getElementById("bulanok").innerText = monthNames[serverTime.getMonth()];
		//document.getElementById("tanggalok").innerText = serverTime.getDate();
	}

	fetchServerTime();
	setInterval(updateClock, 1000);
	
	var urlGAS= 'https://script.google.com/macros/s/AKfycbxf2uoEFraGhy-kbRI0bneqD2MUk--FSLf_piYrLafS8pG0xdbf0E-vSRmpXcM424vSAw/exec';
    let dataPTK = [];
    let dataLaporan = [];
	
	function firstData()
	{
		Swal.fire({
			title: 'Selamat Datang',
			text: 'Silakan tunggu...',
			allowOutsideClick: false,
			didOpen: () => {
				Swal.showLoading();
			}
		});
        $.ajax({
            url: urlGAS + "?mode=load",
            method: 'GET',
            dataType: 'json',
            success: function(response) 
			{
				//console.log(response);
				// masukkan data petugas
				localStorage.setItem('tahun',response[3].Value);
				localStorage.setItem('gps',response[4].Value);
				localStorage.setItem('koordinat',response[5].Value);
				localStorage.setItem('radius',response[6].Value);
				const ptgs = response[7].Value;

				ptgs.split('#').forEach(item => {
					const [kode, nama, baris, jabatan, foto] = item.split(';');
					dataPTK.push({ kode, nama, baris, jabatan, foto });
				});
				//console.log(dataPTK);
				
				// Jam Kerja
				const jk = response[8].Value;
				let bag = jk.split("#");
				let bulan = ["JAN", "FEB", "MAR", "APR", "MEI", "JUN", "JUL", "AGS", "SEP", "OKT", "NOV", "DES"];
				bulan.forEach((namaBulan, index) => {
					sessionStorage.setItem(`jamKerja${namaBulan}`, bag[index] || "");
				});

				loadRamadhan();
				///Swal.close();
				//if(localStorage.getItem('gps')=="YA"){
					//cekRadius();
				//}else{
					$('#dalamRadius').show();
					Swal.close();
				//}
            },
            error: function() 
			{
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Gagal menginisiasi!'
                });
            }
        });
	}

	function firstLoad() 
	{
		Swal.fire({
			title: 'Selamat Datang',
			text: 'Silakan tunggu...',
			allowOutsideClick: false,
			didOpen: () => {
				Swal.showLoading();
			}
		});
        $.ajax({
            url: urlGAS + "?mode=load",
            method: 'GET',
            dataType: 'json',
            success: function(response) 
			{
				//console.log(response);
				$('#logo').html('<img src='+cekGambar(response[2].Value)+' style="width:100px"></img>');
				// masukkan data petugas
				localStorage.setItem('tahun',response[3].Value);
				localStorage.setItem('gps',response[4].Value);
				localStorage.setItem('koordinat',response[5].Value);
				localStorage.setItem('radius',response[6].Value);
				const ptgs = response[7].Value;

				ptgs.split('#').forEach(item => {
					const [kode, nama, baris, jabatan, foto] = item.split(';');
					dataPTK.push({ kode, nama, baris, jabatan, foto });
				});
				//console.log(dataPTK);
				
				$('#namaLembaga').html(response[0].Value);
				$('#alamatLembaga').html(response[1].Value);
				localStorage.setItem("namaLembaga",response[0].Value);
				localStorage.setItem("alamatLembaga",response[1].Value);
				Swal.close();
				$('#lembaga').show();
				$('#div2').show();
            },
            error: function() 
			{
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Gagal menginisiasi!'
                });
            }
        });
    }
	
	// Koordinat Presensi
	function cekJarak(lat1, lon1, lat2, lon2) 
	{
		const R = 6371000; // Radius bumi dalam meter
		const dLat = (lat2 - lat1) * Math.PI / 180;
		const dLon = (lon2 - lon1) * Math.PI / 180;
		const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
				  Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
				  Math.sin(dLon / 2) * Math.sin(dLon / 2);
		const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
		return R * c;
	}

	function cekRadius() {
		return new Promise((resolve) => {

			if (localStorage.getItem("gps") !== "YA") {
				resolve(true);
				return;
			}

			if (!navigator.geolocation) {
				Swal.fire("Error", "Geolocation tidak didukung browser", "error");
				resolve(false);
				return;
			}

			const koordinat = localStorage.getItem("koordinat");
			const radius = parseFloat(localStorage.getItem("radius"));

			if (!koordinat || !radius) {
				Swal.fire("Error", "Koordinat atau radius belum diatur", "error");
				resolve(false);
				return;
			}

			const [targetLat, targetLon] = koordinat.split(",").map(Number);

			Swal.fire({
				title: "Memeriksa Lokasi...",
				text: "Pastikan GPS aktif & tidak menggunakan Fake GPS",
				allowOutsideClick: false,
				didOpen: () => Swal.showLoading()
			});

			navigator.geolocation.getCurrentPosition(position => {

				const { latitude, longitude } = position.coords;
				const distance = cekJarak(targetLat, targetLon, latitude, longitude);

				Swal.close();

				if (distance > radius) {
					Swal.fire({
						icon: "error",
						//title: "Di Luar Area Absensi",
						html: `Tidak Boleh Absen Diluar Kantor,<br>
						Silahkan Absen Dilokasi Kantor Anda.<br>
						Jarak Anda : <b>${Math.round(distance)} meter</b>`
					});
					resolve(false);
				} else {
					resolve(true);
				}

			}, () => {
				Swal.close();
				Swal.fire("Error", "Gagal mendapatkan lokasi", "error");
				resolve(false);
			});

		});
	}
	
    // Fungsi untuk login petugas
    function loginPetugas() 
	{
		$("#div1").hide();
        $("#div2").show();
    }

	// Fungsi untuk login petugas
    function loginMunfiq() 
	{
		$("#div1").hide();
        $("#div3").show();
    }

	function logPetugas()
	{
		Swal.fire({
			title: 'Loading...',
			text: 'Memeriksa Data',
			allowOutsideClick: false,
			didOpen: () => {
				Swal.showLoading();
			}
		});

		const username = $("#usernamePetugas").val();
		const password = $("#passwordPetugas").val();
		const deviceId = getDeviceId();

		const ptk = dataPTK.find(item => item.kode === username);
		const barisData = ptk ? ptk["baris"] : null;
		//console.log(ptk);
		
		if (barisData !== null) 
		{
			$.ajax({
				url: urlGAS + "?mode=loginptk" + "&user=" + username + "&pass=" + password + "&baris=" + barisData + "&device=" + deviceId,
				method: 'GET',
				dataType: 'json',
				success: function(response) 
				{
					//console.log(response);
					Swal.close(); // Close loading first

					if (response.status === "device_used") {
						Swal.fire({
							icon: "error",
							title: "Perangkat Ditolak",
							text: "Perangkat ini sudah digunakan akun lain"
						});
						return;
					}
					
					if (response.status === "device_denied") {
  						Swal.fire({
    						icon: "error",
    						title: "Akses Ditolak",
    						html: `
								Akun ini sudah terdaftar<br>
      							di <b>perangkat lain</b><br><br>
      							Hubungi Admin untuk reset device
    							`
  							});
  							return;
					}

					if (response.status == "success") {
						// Do something on success
						Swal.fire({
							icon: 'success',
							title: 'Success',
							text: 'Login Berhasil!',
							confirmButtonText: 'OK'
						});
						localStorage.setItem('statuslogin','petugas');
						localStorage.setItem('user',ptk['kode']);
						localStorage.setItem('nip', ptk['kode']);
						localStorage.setItem('baris',ptk['baris']);
						localStorage.setItem('posisi',ptk['jabatan']);
						localStorage.setItem('nama',ptk['nama']);
						localStorage.setItem('foto',ptk['foto']);
						localStorage.setItem('role', response.role);
						
						loadHalPTK();
						loadLibur();

					} else {
						// Show error if login fails
						Swal.fire({
							icon: 'error',
							title: 'Error',
							text: 'NIP/Password Salah. Silakan Ulangi Lagi!',
							confirmButtonText: 'OK'
						});
					}
				},
				error: function() 
				{
					Swal.close(); // Close loading if there is an error
					Swal.fire({
						icon: 'error',
						title: 'Error',
						text: 'Gagal memuat data',
						confirmButtonText: 'OK'
					});
				}
			});
		} else 
		{
			Swal.close(); // Close loading before showing error
			
			setTimeout(function() 
			{
				Swal.fire({
					icon: 'error',
					title: 'Error',
					text: 'Pegawai tidak ditemukan!',
					confirmButtonText: 'OK'
				});
			}, 500);
		}
	}
	
	function awal()
	{
		$('.awal').show();
		$('.hal').hide();
	}

	function logout() {

		// SIMPAN DEVICE ID
		const deviceId = localStorage.getItem("device_id");

		// BERSIHKAN DATA LOGIN SAJA
		localStorage.removeItem("statuslogin");
		localStorage.removeItem("user");
		localStorage.removeItem("nip");
		localStorage.removeItem("baris");
		localStorage.removeItem("posisi");
		localStorage.removeItem("nama");
		localStorage.removeItem("foto");
		localStorage.removeItem("role");

		sessionStorage.clear();

		// KEMBALIKAN DEVICE ID
		localStorage.setItem("device_id", deviceId);

		$('#lembaga').show();
		$('.awal').show();
		$('.hal').hide();

		firstLoad();
	}

	function loadHalPTK()
	{
		$('.namaPetugas').html(localStorage.getItem('nama'));
		$('.posisiPetugas').html(localStorage.getItem('posisi'));
		$('.namaLembaga').html(localStorage.getItem('namaLembaga'));

		$('#fotoProfil').css({
			'background-image': 'url(' + cekGambar(localStorage.getItem('foto')) + ')'
		});

		if (localStorage.getItem("role") === "ADMIN") 
		{
  			$("#menuAdmin").show();
		} else 
		{
  			$("#menuAdmin").hide();
		}		

		$('#lembaga').hide();
		$("#div2").hide();
		firstData();
		$("#halPetugas").show();
	}
	
	function cekGambar(url) 
	{
	  const match = url.match(/(?:drive\.google\.com\/(?:file\/d\/|open\?id=)|docs\.google\.com\/uc\?id=)([-\w]{25,})/);

	  if (match && match[1]) {
		const id = match[1];
		return 'https://lh3.googleusercontent.com/d/' + id;
	  } else {
		return url;
	  }
	}
	
	function loadHalPelanggan()
	{
		$('.namamunfiq').html(localStorage.getItem('nama'));
		$('.wilayah').html(localStorage.getItem('wilayah'));
		$('.idmunfiq').html(localStorage.getItem('user'));
		$('.namaLembaga').html(localStorage.getItem('namaLembaga'));
		$('#lembaga').hide();
		$("#div3").hide();
		firstData();
		$("#halPelanggan").show();
	}

	function isValidURL(string) 
	{
		const pattern = /^(https?:\/\/)?([\w-]+(\.[\w-]+)+)(:\d+)?(\/.*)?$/i;
		return pattern.test(string);
	}

	//function getPresensi()
	//{
		//Swal.fire({
			//title: 'Absensi',
			//text: 'Memuat Data Absensi...',
			//allowOutsideClick: false,
			//didOpen: () => {
				//Swal.showLoading();
			//}
		//});
		
		//okbln = sessionStorage.getItem('bulanok');
		//oktgl = sessionStorage.getItem('tanggalok')
		
		//$.ajax({
			//url: urlGAS + "?mode=loadpresensi&bulan="+okbln+"&baris="+localStorage.getItem('baris'),
			//method: 'GET',
			//dataType: 'json',
			//success: function(response) {
				////console.log(response);
				////console.log(response[okbln]["Kolom1"]);
				//Swal.fire({
					//icon: 'info',
					//title: 'Siap',
					//text: 'Silakan Melakukan Absensi'
				//});
				//get jamMasuk
				//ma = (parseFloat(oktgl) - 1) * 2 + 4;  
				//pu = ma + 1;
				//jamas = response[okbln]["Kolom"+ma];
				//if(jamas==""){jamas="-"};
				//japul = response[okbln]["Kolom"+pu];
				//if(japul==""){japul="-"};
				//$("#jamMasuk").html(jamas);
				//$("#jamPulang").html(japul);
				//$("#prapresensi").hide();
				//$("#rekap").hide();
				//$("#presensi").show();
			//},
			//error: function() {
				//Swal.fire({
					//icon: 'error',
					//title: 'Error',
					//text: 'Gagal memuat data!'
				//});
			//}
		//});
	//}

	function getPresensi()
	{
    	// üî¥ CEK HARI LIBUR SAAT KLIK ABSENSI
    	if (cekHariLibur()) {
        	return;
    	}

    	Swal.fire({
        	title: 'Absensi',
        	text: 'Memuat Data Absensi...',
        	allowOutsideClick: false,
        	didOpen: () => {
            	Swal.showLoading();
        	}
    	});
    
    	okbln = sessionStorage.getItem('bulanok');
    	oktgl = sessionStorage.getItem('tanggalok')
    
    	$.ajax({
        	url: urlGAS + "?mode=loadpresensi&bulan="+okbln+"&baris="+localStorage.getItem('baris'),
        	method: 'GET',
        	dataType: 'json',
        	success: function(response) {

            	Swal.close();

            	ma = (parseFloat(oktgl) - 1) * 2 + 4;  
            	pu = ma + 1;

            	jamas = response[okbln]["Kolom"+ma] || "-";
            	japul = response[okbln]["Kolom"+pu] || "-";

            	$("#jamMasuk").html(jamas);
            	$("#jamPulang").html(japul);

            	$("#prapresensi").hide();
            	$("#rekap").hide();
            	$("#presensi").show();
        	},
        	error: function() {
            	Swal.fire({
                	icon: 'error',
                	title: 'Error',
                	text: 'Gagal memuat data!'
            	});
        	}
    	});
	}

	
	async function presensi(mode) 
	{
		// üîí CEK GPS TERLEBIH DAHULU
		const lolosRadius = await cekRadius();
		if (!lolosRadius) return;
		
		//if (cekHariLibur()) {
    		//Swal.fire({
      		//icon: "info",
      		//title: "Hari Libur",
      		//text: "Absensi tidak dapat dilakukan hari ini"
    		//});
    		//return;
  		//}

    	if (mode !== "M") return presensiPulang(); // pisahkan logika pulang

    	const jamSekarang = $("#jamdigital").text().substring(0,5); // HH:mm
    	const menitSekarang = timeToMinutes(jamSekarang);

    	const batasAwal  = "06:00";
    	const batasAkhir = "10:00";

    	const jamMasukSebelumnya = $("#jamMasuk").text();

    	// 1Ô∏è‚É£ CEK: SUDAH PERNAH ABSEN MASUK
    	if (jamMasukSebelumnya !== "-") {
        	Swal.fire({
            	icon: 'warning',
            	title: 'Sudah Absen Masuk',
            	html: `
                	Anda sudah pernah melakukan <b>absen masuk</b><br>
                	pada pukul <b>${jamMasukSebelumnya}</b>
            	`
       	 	});
        	return;
    	}

    	// 2Ô∏è‚É£ CEK: BELUM ABSEN TAPI SUDAH LEWAT JAM
    	if (
        	menitSekarang < timeToMinutes(batasAwal) ||
        	menitSekarang > timeToMinutes(batasAkhir)
    	) {
        	Swal.fire({
            	icon: 'error',
            	title: 'Absen Ditutup',
            	html: `
                	Absen masuk hanya dapat dilakukan<br>
                	mulai pukul <b>${batasAwal}</b> s/d <b>${batasAkhir}</b> WIB
            	`
        	});
        	return;
    	}

    	// 3Ô∏è‚É£ STATUS REALTIME
    	const jamKerja = "08:00";
    	let status = "Tepat Waktu";

    	if (menitSekarang > timeToMinutes(jamKerja)) {
        	status = `Terlambat ${menitSekarang - timeToMinutes(jamKerja)} menit`;
    	}

    	// 4Ô∏è‚É£ SIMPAN
    	simpanPresensiKeServer("M", "jamMasuk", "", status);
	}


	async function presensiPulang() 
	{
    	const jamSekarang = $("#jamdigital").text().substring(0,5);
    	const menitSekarang = timeToMinutes(jamSekarang);

    	const jamMasuk = $("#jamMasuk").text();
    	const jamPulangSebelumnya = $("#jamPulang").text();

    	// üî¥ HARUS SUDAH ABSEN MASUK
    	if (jamMasuk === "-" || !jamMasuk) {
        	Swal.fire({
            	icon: 'error',
            	title: 'Belum Absen Masuk',
            	text: 'Silakan lakukan absen masuk terlebih dahulu'
        	});
        	return;
    	}

    	// üî¥ CEK SUDAH ABSEN PULANG
    	if (jamPulangSebelumnya !== "-") {
        	Swal.fire({
            	icon: 'warning',
            	title: 'Sudah Absen Pulang',
            	html: `Anda sudah melakukan absensi pulang<br>
                   	pada pukul <b>${jamPulangSebelumnya}</b> WIB`
        	});
        	return;
    	}

    	const hari = new Date().getDay(); // 5 = Jumat
    	const jamMasukMenit = timeToMinutes(jamMasuk);
    	const batasMasukNormal = timeToMinutes("07:30");

    	let jamPulangMinimal;
    	let tambahKeterlambatan = false;

    	// ================================
    	// üïå MODE RAMADHAN
    	// ================================
    	if (isRamadhan()) {

        	if (hari === 5) { 
            	// Jumat Ramadhan
            	jamPulangMinimal = timeToMinutes("15:30");
        	} else {
            	// Senin‚ÄìKamis Ramadhan
            	jamPulangMinimal = timeToMinutes("15:00");
        	}

        	tambahKeterlambatan = false; // ‚ùå TIDAK ADA TAMBAHAN JAM

    	} 
    	// ================================
    	// üìÖ MODE NORMAL
    	// ================================
    	else {

        	if (hari === 5) {
            	jamPulangMinimal = timeToMinutes("16:30"); // Jumat
        	} else {
            	jamPulangMinimal = timeToMinutes("16:00"); // Senin‚ÄìKamis
        	}

        	tambahKeterlambatan = true; // ‚úÖ ADA TAMBAHAN JAM

        	// üî• Tambahkan keterlambatan jika masuk lewat 07:30
        	if (jamMasukMenit > batasMasukNormal) {
            	const telat = jamMasukMenit - batasMasukNormal;
            	jamPulangMinimal += telat;
        	}
    	}

    	// ================================
    	// üî¥ CEK BELUM WAKTUNYA
    	// ================================
    	if (menitSekarang < jamPulangMinimal) {

        	const jam = Math.floor(jamPulangMinimal / 60).toString().padStart(2,'0');
        	const menit = (jamPulangMinimal % 60).toString().padStart(2,'0');

        	Swal.fire({
            	icon: 'error',
            	title: 'Belum Waktunya Pulang',
            	html: `
                	Jam pulang Anda adalah <b>${jam}:${menit}</b><br>
                	${tambahKeterlambatan ? `Karena jam masuk pukul <b>${jamMasuk}</b>` : `(Jam Ramadhan)`}
            	`
        	});
        	return;
    	}

    	// ================================
		// INPUT URAIAN (VERSI FINAL VALID)
		// ================================
		Swal.fire({
			title: 'Uraian Kegiatan',
			input: 'textarea',
			showCancelButton: true,
			confirmButtonText: 'Absen Pulang',
			inputPlaceholder: 'Tuliskan uraian kegiatan...',
			inputValidator: (value) => {

				if (!value) {
					return 'Uraian wajib diisi';
				}

				const clean = value.trim();

				if (clean.length < 5) {
					return 'Uraian minimal 5 karakter';
				} 
				
				if (/^-+$/.test(clean)) {
					return 'Uraian tidak boleh hanya tanda "-"';
				}

				if (!/[a-zA-Z]/.test(clean)) {
					return 'Uraian harus mengandung huruf';
				}

				return null; // valid
			}
		}).then((res) => {
			if (res.isConfirmed) {
				simpanPresensiKeServer("P", "jamPulang", res.value.trim());
			}
		});
	}


	// Fungsi pembantu untuk mengirim data ke Google Apps Script
	function simpanPresensiKeServer(mode, mde, uraian) 
	{
		Swal.fire({
			title: 'Absensi ' + (mode == "M" ? "Masuk" : "Pulang"),
			text: 'Menyimpan Data ...',
			allowOutsideClick: false,
			didOpen: () => { Swal.showLoading(); }
		});

		let okbln = sessionStorage.getItem('bulanok');
		let oktgl = sessionStorage.getItem('tanggalok');
		let okwk = $("#jamdigital").text();
		let okwkt = okwk.split(':').slice(0, 2).join(':');
    
		// AMBIL NAMA DARI LOCALSTORAGE
		let namaPegawai = localStorage.getItem('nama'); 
		let nipPegawai  = localStorage.getItem('nip');

		$.ajax({
			// Tambahkan &nama= dan &uraian= di akhir URL
			url: urlGAS + "?mode=tulispresensi&bulan=" + okbln + "&tanggal=" + oktgl + "&mp=" + mode + "&waktu=" + okwkt + "&baris=" + localStorage.getItem('baris') + "&uraian=" + encodeURIComponent(uraian) + "&nama=" + encodeURIComponent(namaPegawai) + "&nip=" + encodeURIComponent(nipPegawai),
			method: 'GET',
			dataType: 'json',
			success: function(response) {
				Swal.fire({
					icon: 'success',
					title: 'Berhasil',
					text: 'Berhasil menyimpan Absensi ' + (mode == "M" ? "Masuk" : "Pulang")
				});
				$('#' + mde).text(okwkt);
			},
			error: function() {
				Swal.fire({ 
					icon: 'error', 
					title: 'Error', 
					text: 'Gagal mengirim data ke server!' 
				});
			}
		});
	}

	function rekap()
	{
		$('#prapresensi').hide();
		$('#presensi').hide();
		$('#rekap').show();
	}

	function rekapbulan()
	{
		if($('#pilihBulan').val()){
			Swal.fire({
				title: 'Absensi',
				text: 'Memuat Rekap...',
				allowOutsideClick: false,
				didOpen: () => {
					Swal.showLoading();
				}
			});
			
			okbln = $('#pilihBulan').val();
			okthn = localStorage.getItem('tahun');
			
			$.ajax({
				url: urlGAS + "?mode=loadpresensi&bulan="+okbln+"&baris="+localStorage.getItem('baris'),
				method: 'GET',
				dataType: 'json',
				success: function(response) {
					//console.log(response);
					//console.log(response[okbln]["Kolom1"]);
					
					let tbody = document.getElementById("tabelRekapBody");
					tbody.innerHTML = "";

					let year = okthn;
					let month = angkabulan(okbln);
					let lastDay = new Date(year, month, 0).getDate();
					//console.log('Tahun '+year);
					//console.log('Bulan '+month);

					for (let day = 1; day <= lastDay; day++) {
						//let date = new Date(year, month - 1, day);
						
						// Format hari dalam bahasa Indonesia
						//let hari = date.toLocaleDateString("id-ID", { weekday: 'long' });

						// Buat baris tabel
						//let row = document.createElement("tr");
						
						//let day2 = String(day).padStart(2, '0');
						//omM = (day - 1) * 2 + 4;  
						//omP = omM + 1;
						//let kolomM = `Kolom${omM}`;
						//let kolomP = `Kolom${omP}`;
						////console.log(kolomM);
						////console.log(kolomP);
						// Kolom 1: Hari dan Tanggal
						//let col1 = document.createElement("td");col1.innerHTML = hari+'<br/>'+day2+'-'+month+'-'+year;col1.classList.add("tengah");
						//let col2 = document.createElement("td");col2.id=`m-${day}`;col2.textContent = response[okbln][kolomM];col2.classList.add("tengah");
						//let col3 = document.createElement("td");col3.id=`p-${day}`;col3.textContent = response[okbln][kolomP];col3.classList.add("tengah");
						//let col4 = document.createElement("td");col4.id=`ket-${day}`;col4.textContent = "";col4.classList.add("tengah");

						// Tambahkan kolom ke dalam baris
						//row.appendChild(col1);
						//row.appendChild(col2);
						//row.appendChild(col3);
						//row.appendChild(col4);

						// Tambahkan baris ke dalam tabel
						//tbody.appendChild(row);
						let dateObj = new Date(year, month - 1, day);
    					let hariIndex = dateObj.getDay(); // 0=minggu
					    let isoDate = dateObj.toISOString().split("T")[0];
					
					    let hari = dateObj.toLocaleDateString("id-ID", { weekday: 'long' });
					
					    let row = document.createElement("tr");
					
					    let day2 = String(day).padStart(2, '0');
					    let omM = (day - 1) * 2 + 4;  
					    let omP = omM + 1;
					
					    let kolomM = `Kolom${omM}`;
					    let kolomP = `Kolom${omP}`;
					
					    let masukVal = response[okbln][kolomM] || "";
					    let pulangVal = response[okbln][kolomP] || "";
					
					    let col1 = document.createElement("td");
					    col1.innerHTML = hari+'<br/>'+day2+'-'+month+'-'+year;
					    col1.classList.add("tengah");
					
					    let col2 = document.createElement("td");
					    col2.textContent = masukVal;
					    col2.classList.add("tengah");
					
					    let col3 = document.createElement("td");
					    col3.textContent = pulangVal;
					    col3.classList.add("tengah");
					
					    let col4 = document.createElement("td");
					    col4.classList.add("tengah");
					
					    // =========================
					    // üî¥ CEK HARI LIBUR
					    // =========================
					    let keteranganLibur = "";
					
					    if (hariIndex === 0) {
					        keteranganLibur = "Libur Minggu";
					    } else if (hariIndex === 6) {
					        keteranganLibur = "Libur Sabtu";
					    }
					
					    let liburNasional = dataLibur.find(l => l.tanggal === isoDate);
					    if (liburNasional) {
					        keteranganLibur = liburNasional.ket.toUpperCase();
					    }
					
					    if (keteranganLibur !== "") {
					
					        row.style.backgroundColor = "#ffe6e6"; // üî¥ merah muda
					        col4.innerHTML = `<span style="color:red">${keteranganLibur}</span>`;
					    }
					
					    row.appendChild(col1);
					    row.appendChild(col2);
					    row.appendChild(col3);
					    row.appendChild(col4);
					
					    tbody.appendChild(row);
					}
					// hitung jam kerja
					jamKerjaOK = sessionStorage.getItem('jamKerja'+okbln);
					jamKerjaBulanIni = jamKerjaOK.split(';');
					
					//console.log(jamKerjaBulanIni);
					for (let i = 0; i < lastDay; i++) {
						let idx = i + 1;
						let mElement = document.getElementById(`m-${idx}`);
						let pElement = document.getElementById(`p-${idx}`);

						if (mElement) {
							let pM = mElement.textContent.trim();
							//console.log(i+" "+pM);
							//console.log(i+" jk "+jamKerjaBulanIni[i * 2]);
							if(pM.length > 0){
								if(timeToMinutes(pM) > timeToMinutes(jamKerjaBulanIni[i * 2])){
									brp = timeToMinutes(pM) - timeToMinutes(jamKerjaBulanIni[i * 2]);
									$("#ket-"+idx).append('<div style="color:red">Datang Telat '+brp+' Menit</div>');
								}else{
									$("#ket-"+idx).append('<div style="color:green">Datang Sesuai</div>');
								}
							}
						}
						if (pElement) {
							pP = pElement.textContent.trim();
							//console.log(i+" "+pP);
							//console.log(i+" jk "+jamKerjaBulanIni[i * 2 + 1]);
							if(pP.length > 0){
								if(timeToMinutes(pP) < timeToMinutes(jamKerjaBulanIni[i * 2 + 1])){
									brp = timeToMinutes(jamKerjaBulanIni[i * 2 + 1]) - timeToMinutes(pP);
									$("#ket-"+idx).append('<div style="color:red">Pulang Cepat '+brp+' Menit</div>');
								}else{
									$("#ket-"+idx).append('<div style="color:green">Pulang Sesuai</div>');
								}
							}
						}
					}

					
					Swal.close();
					$('#divTabelRekap').show();
				},
				error: function() {
					Swal.fire({
						icon: 'error',
						title: 'Error',
						text: 'Gagal memuat data!'
					});
				}
			});
		}else{
			Swal.fire({
				icon: 'error',
				title: 'Error',
				text: 'Pilih bulan terlebih dahulu!'
			});
		}
	}

	function angkabulan(month) 
	{
		let months = ["JAN", "FEB", "MAR", "APR", "MEI", "JUN", "JUL", "AGU", "SEP", "OKT", "NOV", "DES"];
		let index = months.indexOf(month.toUpperCase());
		return index !== -1 ? String(index + 1).padStart(2, '0') : "Invalid";
	}

	function timeToMinutes(time) 
	{
		if (!time) return 0;  // Jika kosong, anggap 0
		let [hours, minutes] = time.split(":").map(Number);
		return hours * 60 + minutes;
	}

	function halamanAdmin() 
	{

    	// üîê Proteksi role
    	if (localStorage.getItem("role") !== "ADMIN") {
        	Swal.fire({
            	icon: 'error',
            	title: 'Akses Ditolak',
            	text: 'Anda tidak memiliki hak akses Admin'
        	});
        	return;
    	}

    	// Isi role admin di modal
    	$("#roleAdmin").text(localStorage.getItem("role"));

    	// üî• TAMPILKAN MODAL ADMIN
    	const modal = new bootstrap.Modal(document.getElementById('modalAdmin'));
    	modal.show();

    	// Optional: load data admin
    	loadDataPegawai();
	}

	function loadDataPegawai() {
    	$("#tabelPegawai").html(`
        	<tr class="text-center">
            	<td colspan="5">Loading...</td>
        	</tr>
    	`);

    	$.getJSON(urlGAS + "?mode=loadpegawai", function(res) {
        	dataPegawai = res;
        	let html = "";

        	res.forEach(p => {
            	html += `
            	<tr>
                	<td>${p.nip}</td>
                	<td>${p.nama}</td>
                	<td>${p.jabatan}</td>
                	<td>
                    	<span class="badge bg-${p.role === 'ADMIN' ? 'danger' : 'secondary'}">
                        ${p.role}
                    	</span>
                	</td>
                	<td class="text-center">
                    	<button class="btn btn-warning btn-sm"
                        	onclick="editPegawai('${p.nip}')">
                        	Edit
                    	</button>
                    	<button class="btn btn-danger btn-sm"
                        	onclick="hapusPegawai('${p.nip}')">
                        	Hapus
                    	</button>
                	</td>
            	</tr>`;
        	});

        	$("#tabelPegawai").html(html);
    	});
	}

	function formTambahPegawai() 
	{
    	$("#judulPegawai").text("Tambah Pegawai");
    	$("#modePegawai").val("tambah");

    	$("#nipPegawai").prop("disabled", false).val("");
    	$("#namaPegawai").val("");
    	$("#jabatanPegawai").val("");
    	$("#rolePegawai").val("USER");

    	new bootstrap.Modal("#modalPegawai").show();
	}

	function editPegawai(nip) 
	{
    	let p = dataPegawai.find(x => x.nip === nip);

    	$("#judulPegawai").text("Edit Pegawai");
    	$("#modePegawai").val("edit");

    	$("#nipPegawai").val(p.nip).prop("disabled", true);
    	$("#namaPegawai").val(p.nama);
    	$("#jabatanPegawai").val(p.jabatan);
    	$("#rolePegawai").val(p.role);

    	new bootstrap.Modal("#modalPegawai").show();
	}

	function simpanPegawai() 
	{

    	let mode = $("#modePegawai").val();

    	let data = {
        	nip: $("#nipPegawai").val(),
        	nama: $("#namaPegawai").val(),
        	jabatan: $("#jabatanPegawai").val(),
        	role: $("#rolePegawai").val()
    	};

    	$.ajax({
        	url: urlGAS + "?mode=" + (mode === "tambah" ? "tambahpegawai" : "editpegawai"),
        	method: "POST",
        	data: data,
        	success: () => {
            	Swal.fire("Berhasil", "Data tersimpan", "success");
            	loadDataPegawai();
            	bootstrap.Modal.getInstance(
                	document.getElementById("modalPegawai")
            	).hide();
        	}
    	});
	}

	function hapusPegawai(nip) {
    	Swal.fire({
        	title: "Hapus Pegawai?",
        	text: "Data tidak dapat dikembalikan",
        	icon: "warning",
        	showCancelButton: true,
        	confirmButtonText: "Ya, Hapus"
    	}).then(res => {
        	if (res.isConfirmed) {
            	$.post(urlGAS + "?mode=hapuspegawai", { nip }, () => {
                	Swal.fire("Terhapus", "Pegawai dihapus", "success");
                	loadDataPegawai();
            	});
        	}
    	});
	}

	function cekHariLibur() {

    	const now = new Date();
    	const hari = now.getDay(); // 0=minggu, 6=sabtu
    	const today = now.toISOString().split("T")[0];

    	let keterangan = "";

    	// üîπ Sabtu / Minggu
    	if (hari === 0) {
        	keterangan = "LIBUR HARI MINGGU";
    	} 
    	else if (hari === 6) {
        	keterangan = "LIBUR HARI SABTU";
    	}

    	// üîπ Libur Nasional
    	const liburNasional = dataLibur.find(l => l.tanggal === today);
    	if (liburNasional) {
        	keterangan = liburNasional.ket.toUpperCase();
    	}

    	// üî¥ Jika Libur
    	if (keterangan !== "") {
        	Swal.fire({
            	icon: "info",
            	title: "Hari Libur",
            	html: `
                	<h4>${keterangan}</h4>
                	<p>Tidak ada absensi hari ini</p>
            	`
        	});
        	return true;
    	}

    	return false;
	}


	function tombolLibur(ket) {
  		$("#presensi button").prop("disabled", true);
  		$("#presensi").html(`
    		<div class="alert alert-info text-center">
     		 	<h4>${ket}</h4>
      			<p>Tidak ada absensi hari ini</p>
    		</div>
  		`);
	}

	function tombolAktif() {
  		$("#presensi button").prop("disabled", false);
	}

	function loadRamadhan() {
  		$.getJSON(urlGAS + "?mode=getramadhan", function(res) {
    		if (res.data) {
      			ramadhanMulai = res.data.mulai;
      			ramadhanSelesai = res.data.selesai;
    		}
  		});
	}

	function loadLibur() {
    	$.getJSON(urlGAS + "?mode=getlibur", function(res) {
        	if (res.status === "success") {
            	dataLibur = res.libur || [];
        	}
    	});
	}

	function isRamadhan() {
  		if (!ramadhanMulai || !ramadhanSelesai) return false;

  		const today = new Date().toISOString().split("T")[0];

  		return (today >= ramadhanMulai && today <= ramadhanSelesai);
	}
</script>
</body>
</html>
